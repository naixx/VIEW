#include "aux2out.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define AUX_TIP_SET() gpio_set_output(SUNXI_PORT_D_BASE, SUNXI_PIO_15)
#define AUX_TIP_CLR() gpio_clear_output(SUNXI_PORT_D_BASE, SUNXI_PIO_15)
#define AUX_RING_SET() gpio_set_output(SUNXI_PORT_D_BASE, SUNXI_PIO_14)
#define AUX_RING_CLR() gpio_clear_output(SUNXI_PORT_D_BASE, SUNXI_PIO_14)
#define AUX_TIP_IN() (gpio_get_input(SUNXI_PORT_B_BASE ,SUNXI_PIO_03) == 0)

uint8_t aux2out_init()
{
    gpio_init();

    gpio_cfg_output(SUNXI_PORT_D_BASE, SUNXI_PIO_15_IDX);
    gpio_cfg_output(SUNXI_PORT_D_BASE, SUNXI_PIO_14_IDX);
    gpio_cfg_input(SUNXI_PORT_B_BASE, SUNXI_PIO_03_IDX);

    AUX_RING_SET();
    AUX_TIP_SET();

    return 0;
}

static inline int64_t _microSecondDiff(struct timeval *t1, struct timeval *t0)
{
    if(t1 && t0)
    {
        int64_t seconds = t1->tv_sec - t0->tv_sec;
        int64_t micros = t1->tv_usec - t0->tv_usec;
        return micros + (seconds * 1000000);
    }
    else
    {
        return 0;
    }
}

uint8_t aux2out_pulse(uint32_t lengthMs, uint8_t invert)
{
    struct timeval startTime, now;
    gettimeofday(&startTime, 0);
    if(lengthMs)
    {
        if(invert) AUX_TIP_SET(); else AUX_TIP_CLR();
        for(;;)
        {
            usleep(10);
            gettimeofday(&now, 0);
            int64_t diff = _microSecondDiff(&now, &startTime) / 1000;
            if(diff >= lengthMs) break;
        }
        if(invert) AUX_TIP_CLR(); else AUX_TIP_SET();
    }
    else
    {
        if(invert) AUX_TIP_CLR(); else AUX_TIP_SET();
    }
    return 0;
}

uint8_t aux2out_serial_out(char *s)
{
    struct timeval startTime, now;
    uint8_t i;
    uint8_t bytes = 0;
    while(*s) {
        for(i = 0; i < 10; i++) {
            gettimeofday(&startTime, 0);
            if(i == 0) {
                AUX_RING_CLR(); // clear (start bit)
            } else if(i <= 8) {
                if(*s & 1<<(i-1)) {
                    AUX_RING_SET();   // 1
                } else {
                    AUX_RING_CLR();   // 0
                }
            } else {
                AUX_RING_SET(); // set (stop bit)
            }
            for(;;)
            {
                usleep(2);
                gettimeofday(&now, 0);
                int64_t diff = _microSecondDiff(&now, &startTime);
                if(diff >= 773) break; // 1200 baud
            }
        }
        bytes++;
        s++;
    }
    return bytes;
}

uint8_t aux2out_serial_in(char **s, unsigned int timeout_ms)
{
    struct timeval startTime, now;
    int64_t timeout_us = 1000 * (int64_t) timeout_ms;
    uint8_t done = 0;
    uint8_t i;
    uint8_t bytes = 0;
    char buf[256];

    for(;;) {

        gettimeofday(&startTime, 0);
        for(;;) // wait for start bit
        {
            usleep(2);
            gettimeofday(&now, 0);
            int64_t diff = _microSecondDiff(&now, &startTime);
            if(AUX_TIP_IN()) break;
            if(diff >= 773 + (773 / 2) && bytes > 0 || diff > timeout_us) {
                done = 1;
                break;
            }
        }
        if(done) break;
        gettimeofday(&startTime, 0);
        for(;;) // pause for 1.5 bits
        {
            usleep(2);
            gettimeofday(&now, 0);
            int64_t diff = _microSecondDiff(&now, &startTime);
            if(diff >= 773 + (773 / 2)) break; // 1200 baud
        }
        buf[bytes] = '\0';
        for(i = 0; i < 8; i++) { // read in bits
            gettimeofday(&startTime, 0);
            if(!AUX_TIP_IN()) {
                buf[bytes] |= 1<<i;
            }
            for(;;)
            {
                usleep(2);
                gettimeofday(&now, 0);
                int64_t diff = _microSecondDiff(&now, &startTime);
                if(diff >= 775) break; // 1200 baud
            }
        }
        bytes++;
    }
    buf[bytes] = '\0';
    printf("'%s'\n", buf);
    *s = malloc((size_t) (bytes + 1));
    memcpy(*s, buf, (size_t) (bytes + 1));
    return bytes;
}

uint8_t aux2out_serial_transaction(char *send, char **received, unsigned int timeout_ms) {
    aux2out_init();
    uint8_t n = aux2out_serial_out("hello world!");
    printf("sent %d bytes\n", n);
    int i;
    char *rec;
    n = aux2out_serial_in(&rec, 5000);
    printf("received %d bytes: %s\n", n, rec);
}


int main() {
    printf("starting...\n");
    aux2out_init();
    uint8_t n = aux2out_serial_out("hello world!");
    printf("sent %d bytes\n", n);
    int i;
    char *rec;
    n = aux2out_serial_in(&rec, 5000);
    printf("received %d bytes: %s\n", n, rec);
    free(rec);
}
